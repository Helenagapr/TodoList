@page "/todo"

@using global::TodoList.App
@using global::TodoList.DTO
@inject LocalStorageAccessor LocalStorageAccessor // probeer-le d'una instancia d'una classe
@inject HttpClient Http

<PageTitle>Todo</PageTitle>

<h1>To Do List</h1>
@foreach(TodoTask item in tasks){
    <p>
        <input type="checkbox" @bind="item.IsComplete" @onclick = "@(async() => await SaveAsync(item))" /> @item
        <button class="btn-delete" @onclick="@(async () => await DeleteTaskAsync(item))">Eliminar</button>
    </p>
}
<input type="text" @bind="TaskText" />
<button class="btn btn-primary" @onclick="AddtaskAsync">Afegir</button>

@code {
    private List<TodoTask> tasks = new();
    private string? TaskText{get; set;}

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if(firstRender) {
            tasks = await Http.GetFromJsonAsync<List<TodoTask>>("https://localhost:7286/api/TodoItems");
            StateHasChanged();
        }
    }

    private async Task SaveAsync(TodoTask item) {
        // ESTA FEO NO HACER
        await Task.Delay(1);
        await Http.PutAsJsonAsync($"https://localhost:7286/api/TodoItems/{item.Id}", item);
        
        //await LocalStorageAccessor.SetValueAsync<List<TodoTask>>("todos", tasks);
    }
    private async Task AddtaskAsync() {
        var task = new TodoTask {Name = TaskText};
        tasks.Add(task);
        await Http.PostAsJsonAsync("https://localhost:7286/api/TodoItems", task);
        TaskText = "";
    }

    private async Task DeleteTaskAsync(TodoTask item)
    {
        tasks.Remove(item);
        await Http.DeleteAsync($"https://localhost:7286/api/TodoItems/{item.Id}");
    }

    
}
